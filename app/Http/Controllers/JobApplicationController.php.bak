<?php

namespace App\Http\Controllers;

use App\Models\Job;
use App\Models\JobApplication;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Log;

class JobApplicationController extends Controller
{
    /**
     * Apply to a job (store application)
     */
    public function apply(Request $request, $jobId)
    {
        $request->validate([
            'resume' => 'nullable|file|mimes:pdf,doc,docx|max:5120', // 5MB limit
            'cover_letter' => 'nullable|string|max:5000',
        ]);

        $user = Auth::user();
        if (!$user) {
            return redirect()->route('login')->with('error', 'Silakan login untuk melamar.');
        }

        $job = Job::findOrFail($jobId);

        // prevent duplicate apply
        $exists = JobApplication::where('job_id', $job->id)
            ->where('user_id', $user->id)
            ->exists();
        if ($exists) {
            return back()->with('error', 'Anda sudah pernah melamar pekerjaan ini.');
        }

        $resumePath = null;
        if ($request->hasFile('resume')) {
            // store in storage/app/public/resumes/{jobId}/{userId}/
            $resumePath = $request->file('resume')->store("resumes/{$job->id}/{$user->id}", config('filesystems.resumes_disk', 'public'));
        }

        $application = JobApplication::create([
            'job_id' => $job->id,
            'user_id' => $user->id,
            'resume_path' => $resumePath,
            'cover_letter' => $request->input('cover_letter'),
            // Normalize status naming: keep 'applied' for backward-compat (your project used 'submitted' in roadmap).
            'status' => 'applied',
            'applied_at' => now(),
        ]);

        // TODO: send notification/email to employer (later)
        return back()->with('success', 'Lamaran terkirim. Terima kasih!');
    }

    /**
     * Employer view: list applications for jobs the current user owns (company owner)
     */
    public function indexForEmployer(Request $request)
    {
        $user = Auth::user();
        if (!$user) abort(403);

        // If user is admin (if hasRole exists)
        if (method_exists($user, 'hasRole') && $user->hasRole('admin')) {
            $apps = JobApplication::with(['job','user'])->latest()->paginate(20);
            return view('employer.applications.index', compact('apps'));
        }

        // Determine company IDs the user is associated with
        $companyIds = [];

        // If user has a company_id column (common simple setup)
        if (isset($user->company_id) && $user->company_id) {
            $companyIds[] = $user->company_id;
        }

        // If user has companies() relation (many-to-many), include them
        if (method_exists($user, 'companies')) {
            try {
                $fromRel = $user->companies()->pluck('companies.id')->toArray();
                if (!empty($fromRel)) {
                    $companyIds = array_merge($companyIds, $fromRel);
                }
            } catch (\Throwable $e) {
                // ignore if relation not present or other DB issues
                Log::debug("indexForEmployer: unable to read user->companies relation", ['err'=>$e->getMessage()]);
            }
        }

        if (empty($companyIds)) {
            // no companies found => not authorized to view employer dashboard
            abort(403);
        }

        $apps = JobApplication::with(['job','user'])
            ->whereHas('job', function($q) use ($companyIds) {
                $q->whereIn('company_id', $companyIds);
            })
            ->latest()
            ->paginate(20);

        return view('employer.applications.index', compact('apps'));
    }

    /**
     * Employer change status of an application
     */
    public function changeStatus(Request $request, $id)
    {
        $request->validate([
            'status' => 'required|in:applied,viewed,shortlisted,interview,rejected,hired',
        ]);

        $application = JobApplication::with('job')->findOrFail($id);

        $user = Auth::user();
        if (!$user) abort(403);

        // Authorization: admin OR company owner/recruiter for application's job
        $allowed = false;

        if (method_exists($user, 'hasRole') && $user->hasRole('admin')) {
            $allowed = true;
        }

        // check simple company_id equality
        if (! $allowed && isset($user->company_id) && isset($application->job->company_id) && $user->company_id == $application->job->company_id) {
            $allowed = true;
        }

        // fallback: if company and user have many-to-many relations
        if (! $allowed) {
            try {
                if (isset($application->job->company_id)) {
                    $companyModel = $application->job->company;
                    if ($companyModel && method_exists($companyModel, 'users')) {
                        $belongs = $companyModel->users()->where('user_id', $user->id)->exists();
                        if ($belongs) $allowed = true;
                    }
                }
            } catch (\Throwable $e) {
                Log::debug('changeStatus: company membership check failed', ['err'=>$e->getMessage()]);
            }
        }

        if (! $allowed) {
            Log::warning('Unauthorized changeStatus attempt', [
                'actor_id' => $user->id ?? null,
                'application_id' => $application->id,
                'job_id' => $application->job->id ?? null,
            ]);
            abort(403, 'Tidak diizinkan untuk mengubah status lamaran ini.');
        }

        $application->status = $request->status;
        $application->save();

        // (Opsional) Notifikasi ke pelamar â€” tambahkan event/notification di sini

        if ($request->wantsJson() || $request->ajax()) {
            return response()->json(['success' => true, 'status' => $application->status]);
        }

        return back()->with('success', 'Status aplikasi diperbarui.');
    }

    /**
     * Download resume (only employer/admin/applicant)
     */
    public function downloadResume(Request $request, $id)
    {
        $app = JobApplication::with('job.company','user')->findOrFail($id);
        $user = Auth::user();
        if (!$user) abort(403);

        // If applicant requests their own resume => allow
        if ($user->id === $app->user_id) {
            if (!$app->resume_path) abort(404);
            $disk = config('filesystems.resumes_disk', 'public');
            return Storage::disk($disk)->download($app->resume_path);
        }

        // Admin
        if (method_exists($user, 'hasRole') && $user->hasRole('admin')) {
            if (!$app->resume_path) abort(404);
            $disk = config('filesystems.resumes_disk', 'public');
            return Storage::disk($disk)->download($app->resume_path);
        }

        // Employer/company checks:
        $allowed = false;

        // direct company_id comparison (simple setup)
        if (isset($user->company_id) && isset($app->job->company_id) && $user->company_id == $app->job->company_id) {
            $allowed = true;
        }

        // fallback to membership via relations
        if (! $allowed) {
            try {
                $company = $app->job->company;
                if ($company && method_exists($company, 'users')) {
                    $belongs = $company->users()->where('user_id', $user->id)->exists();
                    if ($belongs) $allowed = true;
                }
            } catch (\Throwable $e) {
                Log::debug('downloadResume: company membership check failed', ['err'=>$e->getMessage()]);
            }
        }

        if (! $allowed) {
            Log::warning('Unauthorized resume download', [
                'actor_id' => $user->id ?? null,
                'application_id' => $app->id,
                'job_id' => $app->job->id ?? null,
            ]);
            abort(403, 'Tidak diizinkan untuk mengunduh file ini.');
        }

        if (!$app->resume_path) abort(404);

        $disk = config('filesystems.resumes_disk', 'public');

        Log::info('Resume download check', [
            'disk' => $disk,
            'path' => $app->resume_path,
            'exists' => Storage::disk($disk)->exists($app->resume_path),
            'actor_id' => $user->id ?? null,
        ]);

        if (! Storage::disk($disk)->exists($app->resume_path)) {
            abort(404, 'File resume tidak ditemukan di storage.');
        }

        // prepare filename
        $orig = basename($app->resume_path);
        $ext = pathinfo($orig, PATHINFO_EXTENSION);
        $cleanUser = isset($app->user->name) ? preg_replace('/\s+/', '_', strtolower($app->user->name)) : 'applicant';
        $downloadName = "{$cleanUser}_cv." . ($ext ?: 'pdf');

        return Storage::disk($disk)->download($app->resume_path, $downloadName);
    }
}

