<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Auth;
use App\Models\JobPackage;
use App\Models\JobPayment;
use App\Services\MidtransClient;

class JobPurchaseController extends Controller
{
    protected MidtransClient $midtrans;

    public function __construct(MidtransClient $midtrans)
    {
        $this->midtrans = $midtrans;
        $this->middleware('auth')->only(['create', 'store']);
    }

    /**
     * User returned after payment flow (Finish URL)
     * We DO NOT trust this 100% â€” verify via Midtrans status API.
     */
    public function finish(Request $request)
    {
        $orderId = $request->query('order_id') ?? $request->query('orderId') ?? null;
        if (!$orderId) {
            // no order id â€” show generic page
            return view('purchase.finish')->with(['status' => 'unknown', 'message' => 'Tidak ada order_id di URL.']);
        }

        try {
            $statusResp = $this->midtrans->getStatus($orderId);
            // statusResp includes 'transaction_status', 'fraud_status', etc.
            $txStatus = strtolower($statusResp['transaction_status'] ?? '');
            $fraud = strtolower($statusResp['fraud_status'] ?? '');

            // Map midtrans status to our state
            $isPaid = in_array($txStatus, ['settlement','capture']) && ($fraud === '' || $fraud === 'accept');

            // optional: fetch local payment row
            $payment = JobPayment::where('external_id', $orderId)->first();

            return view('purchase.finish', [
                'status' => $isPaid ? 'paid' : $txStatus,
                'midtrans' => $statusResp,
                'payment' => $payment,
            ]);
        } catch (\Exception $e) {
            \Log::error('Finish check midtrans status error: '.$e->getMessage(), ['order_id'=>$orderId]);
            return view('purchase.finish')->with(['status' => 'error', 'message' => 'Gagal memeriksa status pembayaran. Silakan cek dashboard atau tunggu notifikasi.']);
        }
    }

    /**
     * Unfinish: user did not complete (or returned early).
     * We still try to check status; usually transaction is not paid.
     */
    public function unfinish(Request $request)
    {
        $orderId = $request->query('order_id') ?? null;
        if (!$orderId) {
            return view('purchase.unfinish')->with(['status' => 'unknown']);
        }

        try {
            $statusResp = $this->midtrans->getStatus($orderId);
            $txStatus = strtolower($statusResp['transaction_status'] ?? '');
            return view('purchase.unfinish', ['status' => $txStatus, 'midtrans' => $statusResp]);
        } catch (\Exception $e) {
            \Log::error('Unfinish check midtrans status error: '.$e->getMessage());
            return view('purchase.unfinish')->with(['status' => 'error']);
        }
    }

    /**
     * Error page: user returned after error.
     * Also verify via API.
     */
    public function error(Request $request)
    {
        $orderId = $request->query('order_id') ?? null;
        if (!$orderId) {
            return view('purchase.error')->with(['status' => 'unknown']);
        }

        try {
            $statusResp = $this->midtrans->getStatus($orderId);
            $txStatus = strtolower($statusResp['transaction_status'] ?? '');
            return view('purchase.error', ['status' => $txStatus, 'midtrans' => $statusResp]);
        } catch (\Exception $e) {
            \Log::error('Error check midtrans status error: '.$e->getMessage());
            return view('purchase.error')->with(['status' => 'error']);
        }
    }

    protected function ensureIsCompany($user): bool
    {
        if (!$user) return false;
        if (method_exists($user, 'hasRole')) {
            return $user->hasRole('company') || $user->hasRole('employer');
        }
        if (property_exists($user, 'company_id') && !empty($user->company_id)) {
            return true;
        }
        if (property_exists($user, 'is_company') && $user->is_company) {
            return true;
        }
        return false;
    }

    /**
     * Menyajikan halaman pemilihan paket untuk job tertentu.
     * Ambil job_id dari query string (contoh: /purchase/create?job_id=221)
     * Jika tidak ada job_id, arahkan employer ke pembuatan job terlebih dahulu.
     */
    public function create(Request $request)
    {
        // Ambil job_id dari query string (URL seperti ?job_id=221)
        $jobId = $request->query('job_id');

        if (! $jobId) {
            // kalau tidak ada, arahkan employer untuk membuat job terlebih dahulu
            return redirect()->route('employer.jobs.create')
                ->with('info', 'Silakan buat lowongan terlebih dahulu, lalu pilih paket untuk lowongan tersebut.');
        }

        // Ambil job tanpa validasi form â€” jika job tidak ditemukan, tampilkan 404
        $job = \App\Models\Job::findOrFail($jobId);

        // Ambil daftar paket
        $packages = \App\Models\JobPackage::all();

        // Kirim job & packages ke view
        return view('purchase.create', compact('job', 'packages'));
    }

    public function store(Request $request)
    {
        $data = $request->validate([
            'job_id' => 'required|exists:jobs,id',
            'package_id' => 'required|exists:job_packages,id',
        ]);

        $job = \App\Models\Job::findOrFail($data['job_id']);
        $package = \App\Models\JobPackage::findOrFail($data['package_id']);

        $externalId = 'jobpay-'.(string) \Illuminate\Support\Str::uuid();

        $payment = \App\Models\JobPayment::create([
            'job_id' => $job->id,
            'company_id' => $job->company_id,
            'package_id' => $package->id,
            'external_id' => $externalId,
            'amount' => $package->price ?? 0,
            'currency' => 'IDR',
            'payment_gateway' => 'midtrans',
            'status' => 'pending',
            'started_at' => now(),
        ]);

        // call your Midtrans service to create transaction (ensure it uses order_id = external_id)
        $midtrans = app(\App\Services\MidtransClient::class);
        try {
            $txn = $midtrans->createTransaction($payment, $package);
            // redirect/show page to let user complete payment (your implementation may differ)
            return redirect()->route('purchase.show', ['payment' => $payment->id]);
        } catch (\Throwable $e) {
            $payment->status = 'failed';
            $payment->save();
            return back()->withErrors('Gagal membuat transaksi: '.$e->getMessage());
        }
    }
}

