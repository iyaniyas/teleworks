<?php

use App\Http\Controllers\ProfileController;
use Illuminate\Support\Facades\Route;
use Illuminate\Support\Facades\Auth;

use App\Http\Controllers\ListingController;
use App\Http\Controllers\SearchController;
use App\Http\Controllers\JobController;
use App\Http\Controllers\CompanyController;
use App\Http\Controllers\JobApplicationController;

// Seeker
use App\Http\Controllers\Seeker\DashboardController as SeekerDashboardController;
use App\Http\Controllers\Seeker\ProfileController as SeekerProfileController;
use App\Http\Controllers\Seeker\ApplicationController as SeekerApplicationController;
use App\Http\Controllers\Seeker\SavedController as SeekerSavedController;

// Admin
use App\Http\Controllers\Admin\AdminController;
use App\Http\Controllers\Admin\CompanyController as AdminCompanyController;
use App\Http\Controllers\Admin\JobController as AdminJobController;
use App\Http\Controllers\Admin\ReportController as AdminReportController;

use App\Http\Controllers\JobPurchaseController;
use App\Http\Controllers\MidtransController;

//finish url midtrans
// finish/unfinish/error pages (user redirect)
Route::get('/purchase/finish', [JobPurchaseController::class, 'finish'])->name('purchase.finish');
Route::get('/purchase/unfinish', [JobPurchaseController::class, 'unfinish'])->name('purchase.unfinish');
Route::get('/purchase/error', [JobPurchaseController::class, 'error'])->name('purchase.error');

// webhook (public) â€” keep in api.php or web.php but ensure CSRF not blocking
//Route::post('/api/midtrans/webhook', [MidtransController::class, 'webhook'])->name('midtrans.webhook');

// Public report controller
use App\Http\Controllers\ReportController;

//billing routes
Route::get('/pricing', function () { return view('pricing'); })->name('pricing');

// Purchase routes (require auth)
Route::middleware(['web'])->group(function () {
    Route::get('/purchase/create', [JobPurchaseController::class, 'create'])->name('purchase.create')->middleware('auth');
    Route::post('/purchase', [JobPurchaseController::class, 'store'])->name('purchase.store')->middleware('auth');
});


/*
|--------------------------------------------------------------------------
| Employer routes (company-only)
|--------------------------------------------------------------------------
*/
Route::group([
    'prefix' => 'employer',
    'as' => 'employer.',
    'middleware' => ['auth', 'role:company']
], function () {

    Route::get('/dashboard', [App\Http\Controllers\Employer\DashboardController::class, 'index'])
        ->name('dashboard');

    // Jobs
    Route::resource('jobs', App\Http\Controllers\Employer\JobController::class);

    // Applicants
    Route::get('jobs/{job}/applicants', [App\Http\Controllers\Employer\ApplicantController::class, 'index'])
        ->name('jobs.applicants.index');

    Route::post('applicants/{applicant}/status', [App\Http\Controllers\Employer\ApplicantController::class, 'updateStatus'])
        ->name('applicants.updateStatus');

    Route::post('applicants/{applicant}/note', [App\Http\Controllers\Employer\ApplicantController::class, 'addNote'])
        ->name('applicants.addNote');

    // Company profile
    Route::get('company', [App\Http\Controllers\Employer\CompanyController::class, 'edit'])
        ->name('company.edit');

    Route::post('company', [App\Http\Controllers\Employer\CompanyController::class, 'update'])
        ->name('company.update');
});


/*
|--------------------------------------------------------------------------
| Seeker routes (job_seeker)
|--------------------------------------------------------------------------
*/
Route::middleware(['auth', 'role:job_seeker'])->group(function () {

    Route::get('/seeker/dashboard', [SeekerDashboardController::class, 'index'])
        ->name('seeker.dashboard');

    // Profile
    Route::get('/seeker/profile', [SeekerProfileController::class, 'edit'])
        ->name('seeker.profile.edit');
    Route::patch('/seeker/profile', [SeekerProfileController::class, 'update'])
        ->name('seeker.profile.update');

    // Applications
    Route::get('/seeker/applications', [SeekerApplicationController::class, 'index'])
        ->name('seeker.applications.index');
    Route::post('/seeker/applications/{id}/withdraw', [SeekerApplicationController::class, 'withdraw'])
        ->name('seeker.applications.withdraw');

    // Saved
    Route::get('/seeker/saved', [SeekerSavedController::class, 'index'])
        ->name('seeker.saved.index');
    Route::post('/jobs/{id}/bookmark', [SeekerSavedController::class, 'toggle'])
        ->name('jobs.bookmark');

    // Apply job
    Route::post('/loker/{id}/apply', [JobApplicationController::class, 'apply'])
        ->name('jobs.apply');
});


/*
|--------------------------------------------------------------------------
| Employer + Admin: manage applications
|--------------------------------------------------------------------------
*/
Route::middleware(['auth', 'role:company|admin'])->group(function () {

    Route::get('/employer/applications', [JobApplicationController::class, 'indexForEmployer'])
        ->name('employer.applications');

    Route::post('/employer/applications/{id}/status', [JobApplicationController::class, 'changeStatus'])
        ->name('employer.applications.status');

    Route::get('/employer/applications/{id}/resume', [JobApplicationController::class, 'downloadResume'])
        ->name('employer.applications.resume');
});


/*
|--------------------------------------------------------------------------
| Company CRUD (authenticated)
|--------------------------------------------------------------------------
*/
Route::middleware('auth')->group(function () {
    Route::get('/company/create', [CompanyController::class, 'create'])->name('companies.create');
    Route::post('/company', [CompanyController::class, 'store'])->name('companies.store');
});

/*
|--------------------------------------------------------------------------
| Company edit (company or admin)
|--------------------------------------------------------------------------
*/
Route::middleware(['auth', 'role:company|admin'])->group(function () {
    Route::get('/company/{company}/edit', [CompanyController::class, 'edit'])->name('companies.edit');
    Route::patch('/company/{company}', [CompanyController::class, 'update'])->name('companies.update');
});

/*
|--------------------------------------------------------------------------
| Public company profile
|--------------------------------------------------------------------------
*/
Route::get('/company/{slug}', [CompanyController::class, 'show'])->name('companies.show');


/*
|--------------------------------------------------------------------------
| Loker edit (auth)
|--------------------------------------------------------------------------
*/
Route::middleware('auth')->group(function () {
    Route::get('/loker/{id}/edit', [JobController::class, 'edit'])->name('jobs.edit');
    Route::patch('/loker/{id}', [JobController::class, 'update'])->name('jobs.update');
});


/*
|--------------------------------------------------------------------------
| Admin routes
|--------------------------------------------------------------------------
*/
Route::middleware(['auth','role:admin'])
    ->prefix('admin')->name('admin.')
    ->group(function () {

    Route::get('/', [AdminController::class, 'dashboard'])->name('dashboard');

    // Companies
    Route::get('companies', [AdminCompanyController::class, 'index'])->name('companies.index');
    Route::get('companies/{company}', [AdminCompanyController::class, 'show'])->name('companies.show');
    Route::post('companies/{company}/verify', [AdminCompanyController::class, 'verify'])->name('companies.verify');
    Route::post('companies/{company}/unverify', [AdminCompanyController::class, 'unverify'])->name('companies.unverify');
    Route::post('companies/{company}/suspend', [AdminCompanyController::class, 'suspend'])->name('companies.suspend');
    Route::post('companies/{company}/unsuspend', [AdminCompanyController::class, 'unsuspend'])->name('companies.unsuspend');

    // Jobs
    Route::get('jobs', [AdminJobController::class, 'index'])->name('jobs.index');
    Route::get('jobs/{job}/edit', [AdminJobController::class, 'edit'])->name('jobs.edit');
    Route::put('jobs/{job}', [AdminJobController::class, 'update'])->name('jobs.update');
    Route::delete('jobs/{job}', [AdminJobController::class, 'destroy'])->name('jobs.destroy');

    // Reports (admin)
    Route::get('reports', [AdminReportController::class,'index'])->name('reports.index');
    Route::get('reports/{report}', [AdminReportController::class,'show'])->name('reports.show');
    Route::post('reports/{report}/resolve', [AdminReportController::class,'resolve'])->name('reports.resolve');
});


/*
|--------------------------------------------------------------------------
| Home
|--------------------------------------------------------------------------
*/
Route::get('/', [ListingController::class, 'home'])->name('home');


/*
|--------------------------------------------------------------------------
| AJAX external jobs
|--------------------------------------------------------------------------
*/
Route::get('/ajax/external-jobs', [SearchController::class, 'externalJobsAjax'])
    ->name('search.external.ajax');


/*
|--------------------------------------------------------------------------
| Public search logs
|--------------------------------------------------------------------------
*/
Route::get('/pencarian-terbaru', [\App\Http\Controllers\PublicSearchLogController::class, 'index'])
    ->name('public.searchlogs');


/*
|--------------------------------------------------------------------------
| SEO-friendly search
|--------------------------------------------------------------------------
*/
Route::get('/cari/lokasi/{lokasi}', [SearchController::class, 'slugLocation'])
    ->name('search.slug.location');

Route::get('/cari/{kata}/{lokasi?}', [SearchController::class, 'slug'])
    ->name('search.slug');

Route::get('/cari', [SearchController::class, 'index'])
    ->name('search.index')
    ->middleware('lowercase.query');


/*
|--------------------------------------------------------------------------
| Job detail
|--------------------------------------------------------------------------
*/
Route::get('/loker/{id}', [JobController::class, 'show'])->name('jobs.show');


/*
|--------------------------------------------------------------------------
| Dashboard legacy
|--------------------------------------------------------------------------
*/
Route::get('/dashboard', function () {
    return view('dashboard');
})
->middleware(['auth','verified'])
->name('dashboard');


/*
|--------------------------------------------------------------------------
| User Profile
|--------------------------------------------------------------------------
*/
Route::middleware('auth')->group(function () {

    Route::get('/profile', [ProfileController::class, 'show'])->name('profile.show');
    Route::get('/profile/edit', [ProfileController::class, 'edit'])->name('profile.edit');
    Route::patch('/profile', [ProfileController::class, 'update'])->name('profile.update');
    Route::delete('/profile', [ProfileController::class, 'destroy'])->name('profile.destroy');
});


/*
|--------------------------------------------------------------------------
| Logout
|--------------------------------------------------------------------------
*/
Route::post('/logout', function () {
    Auth::logout();
    return redirect('/');
})
->middleware('auth')
->name('logout');


/*
|--------------------------------------------------------------------------
| Public report route (submit report)
|--------------------------------------------------------------------------
*/
Route::middleware(['auth', 'throttle:10,1'])
    ->post('/reports', [ReportController::class, 'store'])
    ->name('reports.store');


/*
|--------------------------------------------------------------------------
| Static Pages
|--------------------------------------------------------------------------
*/
Route::view('/about', 'about')->name('about');
Route::view('/privacy', 'privacy')->name('privacy');


/*
|--------------------------------------------------------------------------
| Auth Routes
|--------------------------------------------------------------------------
*/
require __DIR__.'/auth.php';

